<!DOCTYPE html>
<html>
<head>
    <title>Clinical Trial Extractor - Review System</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .collapsible-content.open { max-height: 3000px; }
        .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Clinical Trial Data Extractor</h1>
            <p class="text-gray-600">AI-powered extraction with dual independent review</p>
            
            <div class="flex gap-6 mt-4 border-b">
                <button onclick="showTab('extract')" id="tab-extract" class="pb-2 font-medium tab-active">Extract New</button>
                <button onclick="showTab('library')" id="tab-library" class="pb-2 font-medium text-gray-600 hover:text-blue-600">Studies Library</button>
                <button onclick="showTab('review')" id="tab-review" class="pb-2 font-medium text-gray-600 hover:text-blue-600">Review System</button>
                <button onclick="showTab('compare')" id="tab-compare" class="pb-2 font-medium text-gray-600 hover:text-blue-600">Compare Studies</button>
            </div>
        </div>

        <!-- Extract Tab -->
        <div id="extractTab" class="tab-content">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Upload Clinical Trial PDF</h2>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-500 transition cursor-pointer" onclick="document.getElementById('pdfFile').click()">
                    <input type="file" id="pdfFile" accept=".pdf" class="hidden" />
                    <p class="text-lg font-medium text-gray-700" id="fileName">Click to upload PDF</p>
                </div>
                <button onclick="extractData()" class="w-full mt-4 px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">Extract All Trial Data</button>
                <div id="loadingDiv" class="hidden mt-4 p-4 bg-blue-50 rounded-lg"><span class="text-blue-800">Extracting...</span></div>
                <div id="errorDiv" class="hidden mt-4 p-4 bg-red-50 rounded-lg"><p class="text-red-800" id="errorText"></p></div>
            </div>
            <div id="resultsContainer" class="hidden"></div>
        </div>

        <!-- Library Tab -->
        <div id="libraryTab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold">Studies Library</h2>
                    <button onclick="exportAllStudies()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Export All</button>
                </div>
                <div id="studiesLibrary"><p class="text-gray-500">Loading studies...</p></div>
            </div>
        </div>

        <!-- Review Tab -->
        <div id="reviewTab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4">Review System - Dual Independent Review</h2>
                
                <div class="mb-6">
                    <h3 class="font-semibold mb-3">Manage Reviewers</h3>
                    <div class="flex gap-3 mb-3">
                        <input type="text" id="newReviewerName" placeholder="Reviewer Name" class="flex-1 px-4 py-2 border rounded-lg">
                        <input type="email" id="newReviewerEmail" placeholder="Email (optional)" class="flex-1 px-4 py-2 border rounded-lg">
                        <button onclick="addReviewer()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Add Reviewer</button>
                    </div>
                    <div id="reviewersList"></div>
                </div>
                
                <div class="mb-6">
                    <h3 class="font-semibold mb-3">Select Study to Review</h3>
                    <select id="studyToReview" class="w-full px-4 py-2 border rounded-lg mb-3" onchange="loadStudyForReview()">
                        <option value="">-- Select a study --</option>
                    </select>
                    
                    <div id="reviewAssignment" class="hidden">
                        <h4 class="font-semibold mb-2">Assign Reviewers</h4>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="text-sm text-gray-600">Reviewer A</label>
                                <select id="assignReviewerA" class="w-full px-4 py-2 border rounded-lg"><option value="">-- Select --</option></select>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">Reviewer B</label>
                                <select id="assignReviewerB" class="w-full px-4 py-2 border rounded-lg"><option value="">-- Select --</option></select>
                            </div>
                        </div>
                        <button onclick="assignReviewers()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Assign & Start Review</button>
                    </div>
                </div>
                
                <div id="reviewInterface" class="hidden">
                    <div class="mb-4">
                        <label class="text-sm text-gray-600">I am reviewing as:</label>
                        <select id="currentReviewer" class="ml-2 px-4 py-2 border rounded-lg" onchange="loadMyReviews()"><option value="">-- Select --</option></select>
                    </div>
                    <div id="reviewFieldsContainer"></div>
                    <button onclick="markReviewComplete()" class="w-full mt-4 px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700">Mark My Review as Complete</button>
                </div>
            </div>
        </div>

        <!-- Compare Tab -->
        <div id="compareTab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4">Compare Studies</h2>
                <div id="compareSelection"></div>
            </div>
        </div>
    </div>

    <script>
        let allReviewers = [];
        let currentStudyForReview = null;
        let currentReviewerId = null;
        let currentStudyData = null;
        let allStudies = [];
        let myReviews = {};
        const fileInput = document.getElementById('pdfFile');

        document.addEventListener('DOMContentLoaded', () => loadReviewers());

        async function loadReviewers() {
            try {
                const res = await fetch('/api/reviewers');
                const data = await res.json();
                allReviewers = data.reviewers;
                displayReviewers();
                populateReviewerDropdowns();
            } catch (e) {
                console.error('Error loading reviewers:', e);
            }
        }

        function displayReviewers() {
            const container = document.getElementById('reviewersList');
            if (allReviewers.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500 mt-2">No reviewers yet.</p>';
                return;
            }
            container.innerHTML = `<div class="mt-3 p-3 bg-gray-50 rounded-lg"><p class="text-sm font-semibold mb-2">Current Reviewers:</p><div class="flex flex-wrap gap-2">${allReviewers.map(r => `<span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">${r.name}</span>`).join('')}</div></div>`;
        }

        function populateReviewerDropdowns() {
            ['assignReviewerA', 'assignReviewerB', 'currentReviewer'].forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = '<option value="">-- Select --</option>' + allReviewers.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
            });
        }

        async function addReviewer() {
            const name = document.getElementById('newReviewerName').value.trim();
            const email = document.getElementById('newReviewerEmail').value.trim();
            if (!name) return alert('Enter reviewer name');
            
            try {
                const res = await fetch('/api/reviewers', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({name, email})});
                const result = await res.json();
                if (result.success) {
                    document.getElementById('newReviewerName').value = '';
                    document.getElementById('newReviewerEmail').value = '';
                    await loadReviewers();
                    alert('Reviewer added!');
                } else {
                    alert(result.error);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function loadStudyForReview() {
            const studyId = document.getElementById('studyToReview').value;
            if (!studyId) {
                document.getElementById('reviewAssignment').classList.add('hidden');
                document.getElementById('reviewInterface').classList.add('hidden');
                return;
            }
            
            currentStudyForReview = parseInt(studyId);
            const res = await fetch(`/api/studies/${studyId}`);
            currentStudyData = await res.json();
            
            const statusRes = await fetch(`/api/studies/${studyId}/review-status`);
            const status = await statusRes.json();
            
            if (!status.reviewer_a || !status.reviewer_b) {
                document.getElementById('reviewAssignment').classList.remove('hidden');
                document.getElementById('reviewInterface').classList.add('hidden');
            } else {
                document.getElementById('reviewAssignment').classList.add('hidden');
                document.getElementById('reviewInterface').classList.remove('hidden');
                buildReviewInterface();
            }
        }

        async function assignReviewers() {
            const a = parseInt(document.getElementById('assignReviewerA').value);
            const b = parseInt(document.getElementById('assignReviewerB').value);
            if (!a || !b) return alert('Select both reviewers');
            if (a === b) return alert('Select different reviewers');
            
            const res = await fetch(`/api/studies/${currentStudyForReview}/assign-reviewers`, {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({reviewer_a_id: a, reviewer_b_id: b})
            });
            const result = await res.json();
            if (result.success) {
                alert('Reviewers assigned!');
                loadStudyForReview();
            } else {
                alert(result.error);
            }
        }

        function buildReviewInterface() {
            const fields = extractReviewableFields(currentStudyData);
            document.getElementById('reviewFieldsContainer').innerHTML = `<div class="space-y-4">${fields.map(f => createFieldReviewHTML(f)).join('')}</div>`;
        }

        function extractReviewableFields(data) {
            const fields = [];
            const add = (path, label, value, section) => {
                if (value !== null && value !== undefined && value !== '') fields.push({path, label, value, section});
            };
            
            const si = data.study_identification || {};
            add('study_identification.title', 'Title', si.title, 'identification');
            add('study_identification.year', 'Year', si.year, 'identification');
            
            (data.interventions || []).forEach((int, i) => {
                add(`interventions.${i}.arm_name`, `Arm ${i+1} Name`, int.arm_name, 'interventions');
                add(`interventions.${i}.dose`, `Arm ${i+1} Dose`, int.dose, 'interventions');
            });
            
            return fields;
        }

        function createFieldReviewHTML(field) {
            const rev = myReviews[field.path] || {};
            const decision = rev.decision || '';
            
            return `<div class="border rounded-lg p-3" id="field-${field.path.replace(/\./g, '-')}">
                <p class="font-semibold mb-2">${field.label}</p>
                <div class="mb-3 p-2 bg-blue-50 rounded"><p class="text-xs font-semibold">AI:</p><p class="text-sm">${field.value}</p></div>
                <div class="mb-3">
                    <div class="flex gap-3 mb-2">
                        <label class="flex items-center"><input type="radio" name="decision-${field.path}" value="ACCEPT" ${decision === 'ACCEPT' ? 'checked' : ''} class="mr-2"><span class="text-sm">Accept</span></label>
                        <label class="flex items-center"><input type="radio" name="decision-${field.path}" value="REJECT" ${decision === 'REJECT' ? 'checked' : ''} class="mr-2"><span class="text-sm">Reject</span></label>
                        <label class="flex items-center"><input type="radio" name="decision-${field.path}" value="MODIFY" ${decision === 'MODIFY' ? 'checked' : ''} class="mr-2"><span class="text-sm">Modify</span></label>
                    </div>
                    <div id="modify-${field.path.replace(/\./g, '-')}" class="${decision === 'MODIFY' ? '' : 'hidden'}">
                        <input type="text" id="value-${field.path.replace(/\./g, '-')}" value="${rev.reviewer_value || ''}" placeholder="Your value" class="w-full px-3 py-2 border rounded-lg text-sm mb-2">
                    </div>
                </div>
                <textarea id="notes-${field.path.replace(/\./g, '-')}" class="w-full px-3 py-2 border rounded-lg text-sm mb-2" rows="2" placeholder="Notes">${rev.notes || ''}</textarea>
                <button onclick="saveFieldReview('${field.path}', '${field.label}', '${field.section}', ${JSON.stringify(field.value).replace(/"/g, '&quot;')})" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">Save</button>
            </div>`;
        }

        async function saveFieldReview(fieldPath, fieldLabel, section, aiValue) {
            const radios = document.getElementsByName(`decision-${fieldPath}`);
            let decision = '';
            for (const r of radios) if (r.checked) { decision = r.value; break; }
            if (!decision) return alert('Select a decision');
            
            const reviewerValue = document.getElementById(`value-${fieldPath.replace(/\./g, '-')}`).value;
            const notes = document.getElementById(`notes-${fieldPath.replace(/\./g, '-')}`).value;
            if (decision === 'MODIFY' && !reviewerValue) return alert('Enter your value');
            if (!currentReviewerId) return alert('Select which reviewer you are');
            
            const res = await fetch(`/api/studies/${currentStudyForReview}/submit-review`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({reviewer_id: currentReviewerId, field_path: fieldPath, field_label: fieldLabel, section, ai_value: aiValue, decision, reviewer_value: decision === 'MODIFY' ? reviewerValue : null, notes})
            });
            const result = await res.json();
            if (result.success) {
                myReviews[fieldPath] = {decision, reviewer_value: reviewerValue, notes};
                alert('Saved!');
            } else {
                alert('Error: ' + result.error);
            }
        }

        async function loadMyReviews() {
            currentReviewerId = parseInt(document.getElementById('currentReviewer').value);
            if (!currentReviewerId) return;
            
            const res = await fetch(`/api/studies/${currentStudyForReview}/my-reviews/${currentReviewerId}`);
            const data = await res.json();
            myReviews = data.reviews;
            buildReviewInterface();
        }

        async function markReviewComplete() {
            if (!currentReviewerId) return alert('Select reviewer');
            if (!confirm('Mark complete?')) return;
            
            const res = await fetch(`/api/studies/${currentStudyForReview}/complete-review/${currentReviewerId}`, {method: 'POST'});
            const result = await res.json();
            if (result.success) {
                alert('Review complete!');
            } else {
                alert(result.error);
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.querySelectorAll('[id^="tab-"]').forEach(b => {
                b.classList.remove('tab-active');
                b.classList.add('text-gray-600');
            });
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            document.getElementById('tab-' + tabName).classList.add('tab-active');
            document.getElementById('tab-' + tabName).classList.remove('text-gray-600');
            
            if (tabName === 'review') loadReviewTab();
            if (tabName === 'library') loadStudiesLibrary();
        }

        async function loadReviewTab() {
            const res = await fetch('/api/studies');
            const data = await res.json();
            allStudies = data.studies;
            document.getElementById('studyToReview').innerHTML = '<option value="">-- Select --</option>' + 
                allStudies.map(s => `<option value="${s.id}">${s.study_identification.title || 'Untitled'} (${s.study_identification.year || 'N/A'})</option>`).join('');
        }

        async function loadStudiesLibrary() {
            const res = await fetch('/api/studies');
            const data = await res.json();
            allStudies = data.studies;
            const container = document.getElementById('studiesLibrary');
            
            if (allStudies.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No studies. Upload a PDF first.</p>';
                return;
            }
            
            container.innerHTML = allStudies.map(s => `
                <div class="border rounded-lg p-4 mb-3 hover:bg-gray-50">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-900">${s.study_identification.title || 'Untitled'}</h3>
                            <p class="text-sm text-gray-600">${s.study_identification.year || 'N/A'} | ${s.interventions.length} arms</p>
                            <p class="text-xs text-gray-500 mt-1">Extracted: ${s.extraction_date ? new Date(s.extraction_date).toLocaleDateString() : 'N/A'}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="viewStudy(${s.id})" class="px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded hover:bg-blue-200">View</button>
                            <button onclick="reExtractStudy(${s.id})" class="px-3 py-1 text-sm bg-orange-100 text-orange-700 rounded hover:bg-orange-200">Re-extract</button>
                            <button onclick="downloadStudyExcel(${s.id})" class="px-3 py-1 text-sm bg-green-100 text-green-700 rounded hover:bg-green-200">Excel</button>
                            <button onclick="deleteStudy(${s.id})" class="px-3 py-1 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function viewStudy(studyId) {
            try {
                const response = await fetch(`/api/studies/${studyId}`);
                const study = await response.json();
                alert('Study loaded: ' + study.study_identification.title);
            } catch (error) {
                alert('Error loading study');
            }
        }

        async function reExtractStudy(studyId) {
            if (!confirm('Re-extract this study? This will overwrite existing data.')) return;
            
            alert('Re-extraction started. This may take 30-60 seconds...');
            
            try {
                const response = await fetch(`/api/studies/${studyId}/re-extract`, {method: 'POST'});
                const result = await response.json();
                
                if (result.success) {
                    alert('Study re-extracted successfully!');
                    loadStudiesLibrary();
                } else {
                    alert('Re-extraction failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Re-extraction error: ' + error.message);
            }
        }

        async function deleteStudy(studyId) {
            const study = allStudies.find(s => s.id === studyId);
            const studyTitle = study ? (study.study_identification.title || 'this study') : 'this study';
            
            if (!confirm(`DELETE STUDY?\n\n"${studyTitle}"\n\nThis will permanently delete all data. This CANNOT be undone!\n\nContinue?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/studies/${studyId}`, {method: 'DELETE'});
                const result = await response.json();
                
                if (result.success) {
                    allStudies = allStudies.filter(s => s.id !== studyId);
                    loadStudiesLibrary();
                    alert('Study deleted successfully!');
                } else {
                    alert('Delete failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Delete error: ' + error.message);
            }
        }

        function downloadStudyExcel(studyId) {
            window.location.href = `/api/export/csv/${studyId}`;
        }

        function exportAllStudies() {
            window.location.href = '/api/export/all-studies';
        }

        async function extractData() {
            if (!fileInput.files || !fileInput.files[0]) return alert('Select PDF first');
            document.getElementById('loadingDiv').classList.remove('hidden');
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            try {
                const res = await fetch('/api/extract', {method: 'POST', body: formData});
                const result = await res.json();
                if (result.data) {
                    alert('Extraction complete! Study ID: ' + result.study_id);
                    showTab('library');
                    loadStudiesLibrary();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            } finally {
                document.getElementById('loadingDiv').classList.add('hidden');
            }
        }

        fileInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                document.getElementById('fileName').textContent = this.files[0].name;
            }
        });
    </script>
</body>
</html>