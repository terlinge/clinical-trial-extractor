<!DOCTYPE html>
<html>
<head>
    <title>Clinical Trial Extractor</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .collapsible-content.open { max-height: 3000px; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Clinical Trial Data Extractor</h1>
            <p class="text-gray-600">AI-powered extraction for Network Meta-Analyses</p>
            <div class="mt-4 flex items-center gap-2">
                <div class="w-3 h-3 rounded-full bg-green-500"></div>
                <span class="text-sm text-gray-600">Backend Connected</span>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Upload Clinical Trial PDF</h2>
            
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-500 transition cursor-pointer" onclick="document.getElementById('pdfFile').click()">
                <input type="file" id="pdfFile" accept=".pdf" class="hidden" />
                <p class="text-lg font-medium text-gray-700" id="fileName">Click to upload PDF</p>
            </div>

            <button onclick="extractData()" class="w-full mt-4 px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition">
                Extract All Trial Data
            </button>

            <div id="loadingDiv" class="hidden mt-4 p-4 bg-blue-50 rounded-lg">
                <span class="text-blue-800">Extracting... 30-60 seconds...</span>
            </div>

            <div id="errorDiv" class="hidden mt-4 p-4 bg-red-50 rounded-lg">
                <p class="text-red-800" id="errorText"></p>
            </div>
        </div>

        <div id="resultsContainer" class="hidden"></div>
    </div>

    <script>
        const fileInput = document.getElementById('pdfFile');
        let extractedData = null;

        fileInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                document.getElementById('fileName').textContent = this.files[0].name;
            }
        });

        async function extractData() {
            if (!fileInput.files || !fileInput.files[0]) {
                showError('Please select a PDF file first!');
                return;
            }

            document.getElementById('loadingDiv').classList.remove('hidden');
            document.getElementById('errorDiv').classList.add('hidden');

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch('/api/extract', { method: 'POST', body: formData });
                const result = await response.json();

                if (result.data) {
                    extractedData = result.data;
                    displayResults(result.data);
                } else {
                    showError(result.error || 'Extraction failed');
                }
            } catch (error) {
                showError('Error: ' + error.message);
            } finally {
                document.getElementById('loadingDiv').classList.add('hidden');
            }
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorDiv').classList.remove('hidden');
        }

        function toggleSection(id) {
            const content = document.getElementById(id);
            const icon = document.getElementById(id + '-icon');
            content.classList.toggle('open');
            icon.textContent = content.classList.contains('open') ? '▼' : '▶';
        }

        function displayResults(data) {
    const container = document.getElementById('resultsContainer');
    container.classList.remove('hidden');
    
    let html = `
        <div class="bg-white rounded-lg shadow-lg p-4 mb-4">
            <div class="flex items-center justify-between">
                <h2 class="text-xl font-semibold">Extracted Data - CONSORT Compliant</h2>
                <div class="flex gap-2">
                    <button onclick="downloadJSON()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">JSON</button>
                    <button onclick="downloadExcel()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Excel (All Sheets)</button>
                </div>
            </div>
        </div>
    `;

    // Study Identification
    if (data.study_identification) {
        html += createSection('Study Identification', 'id', `
            <div class="space-y-2">
                <h3 class="text-xl font-bold text-gray-900 mb-3">${data.study_identification.title || 'Untitled'}</h3>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div><span class="font-medium">Authors:</span> ${(data.study_identification.authors || []).join(', ')}</div>
                    <div><span class="font-medium">Journal:</span> ${data.study_identification.journal || 'N/A'}</div>
                    <div><span class="font-medium">Year:</span> ${data.study_identification.year || 'N/A'}</div>
                    <div><span class="font-medium">DOI:</span> ${data.study_identification.doi || 'N/A'}</div>
                    <div><span class="font-medium">Trial Registration:</span> ${data.study_identification.trial_registration || 'N/A'}</div>
                </div>
            </div>
        `, true);
    }

    // Study Design
    if (data.study_design) {
        html += createSection('Study Design & Methodology', 'design', `
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div><span class="font-medium">Design Type:</span> ${data.study_design.type || 'N/A'}</div>
                <div><span class="font-medium">Blinding:</span> ${data.study_design.blinding || 'N/A'}</div>
                <div><span class="font-medium">Randomization:</span> ${data.study_design.randomization_method || 'N/A'}</div>
                <div><span class="font-medium">Allocation Concealment:</span> ${data.study_design.allocation_concealment || 'N/A'}</div>
                <div><span class="font-medium">Duration:</span> ${data.study_design.duration_total || 'N/A'}</div>
                <div><span class="font-medium">Country:</span> ${data.study_design.country || 'N/A'}</div>
            </div>
        `, true);
    }

    // Population & Eligibility
    if (data.population) {
        html += createSection(`Population (N=${data.population.total_randomized || '?'})`, 'pop', `
            <div class="grid grid-cols-2 gap-6">
                <div>
                    <h4 class="font-semibold text-gray-700 mb-2">Sample Sizes</h4>
                    <div class="space-y-1 text-sm">
                        <div><span class="font-medium">Screened:</span> ${data.population.total_screened || 'N/A'}</div>
                        <div><span class="font-medium">Randomized:</span> ${data.population.total_randomized || 'N/A'}</div>
                        <div><span class="font-medium">Analyzed (ITT):</span> ${data.population.total_analyzed_itt || 'N/A'}</div>
                    </div>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-700 mb-2">Demographics</h4>
                    <div class="space-y-1 text-sm">
                        <div><span class="font-medium">Mean Age:</span> ${data.population.age_mean || 'N/A'} ${data.population.age_sd ? '(SD ' + data.population.age_sd + ')' : ''}</div>
                        <div><span class="font-medium">Male %:</span> ${data.population.sex_male_percent || 'N/A'}</div>
                    </div>
                </div>
            </div>
            <div class="mt-4 grid grid-cols-2 gap-4">
                <div>
                    <h4 class="font-semibold text-gray-700 mb-2">Inclusion Criteria</h4>
                    <ul class="list-disc pl-5 text-sm space-y-1">
                        ${(data.population.inclusion_criteria || []).map(c => `<li>${c}</li>`).join('')}
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-700 mb-2">Exclusion Criteria</h4>
                    <ul class="list-disc pl-5 text-sm space-y-1">
                        ${(data.population.exclusion_criteria || []).slice(0, 5).map(c => `<li>${c}</li>`).join('')}
                        ${(data.population.exclusion_criteria || []).length > 5 ? '<li class="text-gray-500">... and more</li>' : ''}
                    </ul>
                </div>
            </div>
        `, true);
    }

    // Interventions
    if (data.interventions) {
        html += createSection(`Interventions (${data.interventions.length} arms)`, 'int', `
            <div class="grid grid-cols-3 gap-4">
                ${data.interventions.map((i, idx) => `
                    <div class="border rounded-lg p-4 bg-gray-50">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm">${idx + 1}</span>
                            <h4 class="font-bold text-blue-700">${i.arm_name}</h4>
                        </div>
                        <div class="text-sm space-y-1">
                            <div><span class="font-medium">N Randomized:</span> ${i.n_randomized || 'N/A'}</div>
                            <div><span class="font-medium">N Analyzed:</span> ${i.n_analyzed || 'N/A'}</div>
                            ${i.dose && i.dose !== 'NOT_APPLICABLE' ? `<div><span class="font-medium">Dose:</span> ${i.dose}</div>` : ''}
                            ${i.frequency && i.frequency !== 'NOT_APPLICABLE' ? `<div><span class="font-medium">Frequency:</span> ${i.frequency}</div>` : ''}
                            <div><span class="font-medium">Duration:</span> ${i.duration || 'N/A'}</div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `, true);
    }

    // Primary Outcomes
    if (data.outcomes && data.outcomes.primary) {
        html += createSection(`Primary Outcomes (${data.outcomes.primary.length})`, 'out', 
            data.outcomes.primary.map(o => `
                <div class="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <h4 class="font-bold text-blue-900 mb-2">${o.outcome_name}</h4>
                    <div class="text-sm mb-2">
                        <span class="font-medium">Timepoint:</span> ${o.timepoint || 'N/A'}
                        ${o.measurement_tool ? ` | <span class="font-medium">Tool:</span> ${o.measurement_tool}` : ''}
                    </div>
                    ${o.effect_estimate || o.between_group_comparison ? `
                        <div class="bg-white p-3 rounded border border-blue-300">
                            <h5 class="font-semibold text-sm mb-2">Effect Estimate</h5>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                ${o.effect_estimate ? `
                                    <div><span class="font-medium">Comparison:</span> ${o.effect_estimate.comparison || 'N/A'}</div>
                                    <div><span class="font-medium">Effect:</span> <span class="font-bold text-blue-700">${o.effect_estimate.effect_estimate || 'N/A'}</span> (${o.effect_estimate.effect_measure || 'N/A'})</div>
                                    <div><span class="font-medium">95% CI:</span> [${o.effect_estimate.ci_95_lower || '?'}, ${o.effect_estimate.ci_95_upper || '?'}]</div>
                                    <div><span class="font-medium">P-value:</span> <span class="font-bold">${o.effect_estimate.p_value || 'N/A'}</span></div>
                                ` : ''}
                                ${o.between_group_comparison ? `
                                    <div><span class="font-medium">Comparison:</span> ${o.between_group_comparison.comparison || 'N/A'}</div>
                                    <div><span class="font-medium">Effect:</span> <span class="font-bold text-blue-700">${o.between_group_comparison.effect_estimate || 'N/A'}</span></div>
                                    <div><span class="font-medium">95% CI:</span> [${o.between_group_comparison.ci_95_lower}, ${o.between_group_comparison.ci_95_upper}]</div>
                                    <div><span class="font-medium">P-value:</span> ${o.between_group_comparison.p_value}</div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `).join(''), true);
    }

    // Subgroup Analyses
    if (data.subgroup_analyses && data.subgroup_analyses.length > 0) {
        html += createSection(`Subgroup Analyses (${data.subgroup_analyses.length})`, 'sub',
            data.subgroup_analyses.map(sg => `
                <div class="mb-4 p-4 bg-green-50 rounded-lg border border-green-200">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-bold text-green-900">Subgroup Variable: ${sg.subgroup_variable}</h4>
                        <span class="text-sm bg-green-200 px-2 py-1 rounded">P interaction: ${sg.p_interaction}</span>
                    </div>
                    <div class="space-y-2 mt-3">
                        ${(sg.subgroups || []).map(s => `
                            <div class="bg-white p-3 rounded border border-green-300">
                                <div class="font-semibold text-gray-800 mb-1">${s.subgroup_name}</div>
                                ${s.subgroup_definition ? `<div class="text-xs text-gray-600 mb-2">${s.subgroup_definition}</div>` : ''}
                                ${s.effect_estimate ? `
                                    <div class="grid grid-cols-3 gap-2 text-sm">
                                        <div><span class="font-medium">Effect:</span> ${s.effect_estimate.value}</div>
                                        <div><span class="font-medium">95% CI:</span> [${s.effect_estimate.ci_lower}, ${s.effect_estimate.ci_upper}]</div>
                                        <div><span class="font-medium">P:</span> ${s.effect_estimate.p_value}</div>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join(''), true);
    }

    // Adverse Events
    if (data.adverse_events && data.adverse_events.length > 0) {
        html += createSection(`Adverse Events (${data.adverse_events.length})`, 'ae',
            `<div class="space-y-3">
                ${data.adverse_events.map(ae => `
                    <div class="p-3 bg-yellow-50 rounded border border-yellow-200">
                        <div class="flex items-center justify-between mb-2">
                            <div class="font-semibold text-gray-800">${ae.event_name}</div>
                            <span class="text-xs bg-yellow-200 px-2 py-1 rounded">${ae.severity || ae.category || 'N/A'}</span>
                        </div>
                        <div class="grid grid-cols-${(ae.results_by_arm || []).length} gap-2 text-sm">
                            ${(ae.results_by_arm || []).map(result => `
                                <div class="bg-white p-2 rounded">
                                    <div class="font-medium text-xs text-gray-600">${result.arm}</div>
                                    <div>${result.events || result.participants_with_event} / ${result.total_exposed}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>`, false);
    }

    container.innerHTML = html;
}

        function createSection(title, id, content, isOpen) {
            return `
                <div class="bg-white rounded-lg shadow-lg mb-4 overflow-hidden">
                    <button onclick="toggleSection('${id}-content')" class="w-full px-6 py-4 flex items-center justify-between bg-gradient-to-r from-blue-50 to-white hover:from-blue-100">
                        <div class="flex items-center gap-2">
                            <span id="${id}-content-icon">${isOpen ? '▼' : '▶'}</span>
                            <span class="font-semibold text-gray-800">${title}</span>
                        </div>
                    </button>
                    <div id="${id}-content" class="collapsible-content ${isOpen ? 'open' : ''}">
                        <div class="px-6 py-4">${content}</div>
                    </div>
                </div>
            `;
        }

        function downloadJSON() {
            const blob = new Blob([JSON.stringify(extractedData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'trial_data.json';
            a.click();
        }

        function downloadExcel() {
            if (extractedData && extractedData.id) {
                window.location.href = `/api/export/csv/${extractedData.id}`;
            } else {
                alert('No study ID available for export');
            }
        }
    </script>
</body>
</html>