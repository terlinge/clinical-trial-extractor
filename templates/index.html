<!DOCTYPE html>
<html>
<head>
    <title>Clinical Trial Extractor</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .collapsible-content.open { max-height: 3000px; }
        .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Clinical Trial Data Extractor</h1>
            <p class="text-gray-600">AI-powered extraction for Network Meta-Analyses</p>
            
            <!-- Tabs -->
            <div class="flex gap-6 mt-4 border-b">
                <button onclick="showTab('extract')" id="tab-extract" class="pb-2 font-medium tab-active">
                    Extract New
                </button>
                <button onclick="showTab('library')" id="tab-library" class="pb-2 font-medium text-gray-600 hover:text-blue-600">
                    Studies Library
                </button>
                <button onclick="showTab('compare')" id="tab-compare" class="pb-2 font-medium text-gray-600 hover:text-blue-600">
                    Compare Studies
                </button>
            </div>
        </div>

        <!-- Extract Tab -->
        <div id="extractTab" class="tab-content">
            <!-- New Study Actions - MOVED TO TOP AND SEPARATED -->
            <div id="newStudyActions" class="hidden mb-6 p-6 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg border-2 border-green-300">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-bold text-gray-800">‚úÖ Extraction Complete!</h3>
                        <p class="text-sm text-gray-600 mt-1">Your study has been extracted and saved to the database.</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="extractNewStudy()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium shadow-lg">
                            ‚ûï Extract Another Study
                        </button>
                        <button onclick="goToLibrary()" class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-medium shadow-lg">
                            üìö View Library
                        </button>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Upload Clinical Trial PDF</h2>
                
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-500 transition cursor-pointer" onclick="document.getElementById('pdfFile').click()">
                    <input type="file" id="pdfFile" accept=".pdf" class="hidden" />
                    <p class="text-lg font-medium text-gray-700" id="fileName">Click to upload PDF</p>
                </div>

                <button onclick="extractData()" class="w-full mt-4 px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition">
                    Extract All Trial Data
                </button>

                <div id="loadingDiv" class="hidden mt-4 p-4 bg-blue-50 rounded-lg">
                    <div class="space-y-3">
                        <p class="text-blue-800 font-semibold">Extracting... 30-60 seconds</p>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center gap-2">
                                <div id="status-pdf" class="w-3 h-3 bg-gray-300 rounded-full"></div>
                                <span>PDF Text Extraction (PDFPlumber)</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div id="status-tables" class="w-3 h-3 bg-gray-300 rounded-full"></div>
                                <span>Table Extraction (PDFPlumber + Camelot)</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div id="status-ocr" class="w-3 h-3 bg-gray-300 rounded-full"></div>
                                <span>OCR (if needed for scanned PDFs)</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div id="status-llm" class="w-3 h-3 bg-gray-300 rounded-full"></div>
                                <span>AI Extraction (GPT-4)</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div id="status-save" class="w-3 h-3 bg-gray-300 rounded-full"></div>
                                <span>Saving to Database</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="errorDiv" class="hidden mt-4 p-4 bg-red-50 rounded-lg">
                    <p class="text-red-800" id="errorText"></p>
                </div>
            </div>

            <div id="resultsContainer" class="hidden"></div>
        </div>

        <!-- Library Tab -->
        <div id="libraryTab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold">Studies Library</h2>
                    <button onclick="exportAllStudies()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        Export All Studies
                    </button>
                </div>
                
                <div id="studiesLibrary" class="space-y-3">
                    <p class="text-gray-500">Loading studies...</p>
                </div>
            </div>
        </div>

        <!-- Compare Tab -->
        <div id="compareTab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4">Compare Studies</h2>
                
                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-2">Select 2-4 studies to compare:</p>
                    <div id="compareSelection" class="space-y-2"></div>
                </div>
                
                <button onclick="performComparison()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Compare Selected Studies
                </button>
                
                <div id="comparisonResults" class="mt-6"></div>
            </div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('pdfFile');
        let extractedData = null;
        let allStudies = [];
        let selectedForComparison = [];

        fileInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                document.getElementById('fileName').textContent = this.files[0].name;
            }
        });

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('text-gray-600');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            document.getElementById('tab-' + tabName).classList.add('tab-active');
            document.getElementById('tab-' + tabName).classList.remove('text-gray-600');
            
            // Load data for that tab
            if (tabName === 'library') {
                loadStudiesLibrary();
            } else if (tabName === 'compare') {
                loadCompareView();
            }
        }

        async function extractData() {
            if (!fileInput.files || !fileInput.files[0]) {
                showError('Please select a PDF file first!');
                return;
            }

            // Hide the new study actions if visible
            document.getElementById('newStudyActions').classList.add('hidden');
            document.getElementById('loadingDiv').classList.remove('hidden');
            document.getElementById('errorDiv').classList.add('hidden');
            
            // Reset all status indicators
            ['status-pdf', 'status-tables', 'status-ocr', 'status-llm', 'status-save'].forEach(id => {
                document.getElementById(id).className = 'w-3 h-3 bg-gray-300 rounded-full';
            });
            
            // Simulate progress indicators
            setTimeout(() => {
                document.getElementById('status-pdf').className = 'w-3 h-3 bg-green-500 rounded-full';
            }, 500);
            
            setTimeout(() => {
                document.getElementById('status-tables').className = 'w-3 h-3 bg-green-500 rounded-full';
            }, 1500);
            
            setTimeout(() => {
                document.getElementById('status-llm').className = 'w-3 h-3 bg-yellow-500 rounded-full animate-pulse';
            }, 2500);

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch('/api/extract', { method: 'POST', body: formData });
                const result = await response.json();

                if (result.data || result.success) {
                    // Update progress indicators
                    document.getElementById('status-llm').className = 'w-3 h-3 bg-green-500 rounded-full';
                    document.getElementById('status-save').className = 'w-3 h-3 bg-green-500 rounded-full';
                    
                    // Store extracted data with metadata
                    extractedData = result.data || {};
                    extractedData.id = result.study_id;
                    
                    // Ensure metadata is included
                    if (result.metadata) {
                        extractedData.extraction_metadata = result.metadata;
                        extractedData.confidence_scores = result.metadata.confidence_scores;
                    }
                    
                    displayResults(extractedData);
                    
                    // Show the new study actions at the top
                    document.getElementById('newStudyActions').classList.remove('hidden');
                    
                    // Update extraction count
                    updateExtractionCount();
                } else {
                    // Mark failed status
                    ['status-pdf', 'status-tables', 'status-ocr', 'status-llm', 'status-save'].forEach(id => {
                        const el = document.getElementById(id);
                        if (el.className.includes('gray')) {
                            el.className = 'w-3 h-3 bg-red-500 rounded-full';
                        }
                    });
                    showError(result.error || 'Extraction failed');
                }
            } catch (error) {
                // Mark all as failed
                ['status-pdf', 'status-tables', 'status-ocr', 'status-llm', 'status-save'].forEach(id => {
                    document.getElementById(id).className = 'w-3 h-3 bg-red-500 rounded-full';
                });
                showError('Error: ' + error.message);
            } finally {
                document.getElementById('loadingDiv').classList.add('hidden');
            }
        }

        function displayResults(data) {
            const container = document.getElementById('resultsContainer');
            container.classList.remove('hidden');
            
            let html = '';
            
            // Standards compliance header
            html += '<div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg p-4 mb-4">';
            html += '<div class="flex items-start justify-between">';
            html += '<div>';
            html += '<h3 class="text-lg font-bold mb-1">üìä Extracted Clinical Trial Data</h3>';
            html += '<p class="text-sm opacity-90">Following CONSORT Guidelines & Cochrane Standards for Systematic Reviews and Meta-Analysis</p>';
            html += '</div>';
            html += '<div class="text-right text-xs">';
            html += '<div>‚úì Network Meta-Analysis Ready</div>';
            html += '<div>‚úì All Statistical Parameters</div>';
            html += '<div>‚úì Missing Data Highlighted</div>';
            html += '</div>';
            html += '</div></div>';
            
            // Study-specific action buttons (download buttons for THIS study)
            html += '<div class="mb-4 flex gap-3 flex-wrap">';
            html += '<p class="w-full text-xs text-gray-500 mb-2">Export this study:</p>';
            html += '<button onclick="downloadJSON()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">üì• Download JSON</button>';
            html += '<button onclick="downloadExcel()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">üìä Download Excel</button>';
            if (data.id) {
                html += `<button onclick="reExtractStudy(${data.id})" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-medium">üîÑ Re-extract This Study</button>`;
            }
            html += '</div>';
            
            // TRANSPARENT Data Quality Indicator
            const confidence = (data.confidence_scores?.overall || 0);
            const confidencePercent = (confidence * 100).toFixed(0);
            const bySection = data.confidence_scores?.by_section || {};
            
            let confidenceBg, confidenceBorder, confidenceTextColor, confidenceText;
            
            if (confidence > 0.7) {
                confidenceBg = 'bg-green-50';
                confidenceBorder = 'border-green-200';
                confidenceTextColor = 'text-green-900';
                confidenceText = 'High Completeness';
            } else if (confidence > 0.4) {
                confidenceBg = 'bg-yellow-50';
                confidenceBorder = 'border-yellow-200';
                confidenceTextColor = 'text-yellow-900';
                confidenceText = 'Medium Completeness';
            } else {
                confidenceBg = 'bg-red-50';
                confidenceBorder = 'border-red-200';
                confidenceTextColor = 'text-red-900';
                confidenceText = 'Low Completeness - Manual Review Recommended';
            }
            
            html += `<div class="${confidenceBg} border-2 ${confidenceBorder} rounded-lg p-4 mb-4">`;
            html += `<div class="mb-3">`;
            html += `<div class="flex items-center justify-between mb-2">`;
            html += `<span class="font-semibold ${confidenceTextColor}">Data Completeness Score: ${confidenceText} (${confidencePercent}%)</span>`;
            html += `<button onclick="toggleConfidenceDetails()" class="text-xs text-blue-600 hover:text-blue-800 underline">How is this calculated?</button>`;
            html += `</div>`;
            
            // Confidence Details (Hidden by default)
            html += `<div id="confidenceDetails" class="hidden mt-3 p-3 bg-white rounded border border-gray-200">`;
            html += `<p class="text-xs font-semibold mb-2 text-gray-700">This score reflects how much data was successfully extracted from the PDF:</p>`;
            html += `<div class="space-y-1 text-xs">`;
            html += `<div class="flex justify-between">`;
            html += `<span>Study Identification (title, authors, year, journal, registration):</span>`;
            html += `<span class="font-bold">${((bySection.identification || 0) * 100).toFixed(0)}%</span>`;
            html += `</div>`;
            html += `<div class="flex justify-between">`;
            html += `<span>Study Design (type, blinding, randomization, duration, sites):</span>`;
            html += `<span class="font-bold">${((bySection.design || 0) * 100).toFixed(0)}%</span>`;
            html += `</div>`;
            html += `<div class="flex justify-between">`;
            html += `<span>Interventions (arms, doses, sample sizes):</span>`;
            html += `<span class="font-bold">${((bySection.interventions || 0) * 100).toFixed(0)}%</span>`;
            html += `</div>`;
            html += `<div class="flex justify-between">`;
            html += `<span>Outcomes (primary/secondary with statistics):</span>`;
            html += `<span class="font-bold">${((bySection.outcomes || 0) * 100).toFixed(0)}% <span class="text-gray-600">(weighted 50%)</span></span>`;
            html += `</div>`;
            html += `</div>`;
            html += `<div class="mt-2 pt-2 border-t border-gray-200">`;
            html += `<p class="text-xs text-gray-600">Overall score = weighted average (Outcomes count most at 50% weight)</p>`;
            html += `<p class="text-xs text-orange-700 font-semibold mt-1">‚ö†Ô∏è This measures extraction completeness, NOT accuracy. Always verify critical values against the source PDF.</p>`;
            html += `</div>`;
            html += `</div>`;
            
            html += `</div>`;
            html += '</div>';
            
            // All the detailed sections
            html += createSection('Study Identification', 'study-id', formatStudyIdentification(data), true);
            html += createSection('Study Design & Methodology', 'study-design', formatStudyDesign(data), false);
            html += createSection('Population & Eligibility', 'population', formatPopulation(data), true);
            html += createSection('Interventions (CONSORT Flow)', 'interventions', formatInterventions(data), true);
            html += createSection('Primary Outcomes (All Statistical Parameters)', 'primary-outcomes', formatPrimaryOutcomes(data), true);
            html += createSection('Secondary Outcomes', 'secondary-outcomes', formatSecondaryOutcomes(data), false);
            
            if (data.subgroup_analyses && data.subgroup_analyses.length > 0) {
                html += createSection('Subgroup Analyses', 'subgroups', formatSubgroups(data), false);
            }
            
            if (data.adverse_events && data.adverse_events.length > 0) {
                html += createSection('Adverse Events', 'adverse-events', formatAdverseEvents(data), false);
            }
            
            html += createSection('Extraction Metadata', 'metadata', formatMetadata(data), false);
            
            container.innerHTML = html;
        }

        function toggleConfidenceDetails() {
            const details = document.getElementById('confidenceDetails');
            details.classList.toggle('hidden');
        }

        function createSection(title, id, content, isOpen) {
            return `
                <div class="bg-white rounded-lg shadow-lg mb-4 overflow-hidden">
                    <button onclick="toggleSection('${id}-content')" class="w-full px-6 py-4 flex items-center justify-between bg-gradient-to-r from-blue-50 to-white hover:from-blue-100">
                        <div class="flex items-center gap-2">
                            <span id="${id}-content-icon">${isOpen ? '‚ñº' : '‚ñ∂'}</span>
                            <span class="font-semibold text-gray-800">${title}</span>
                        </div>
                    </button>
                    <div id="${id}-content" class="collapsible-content ${isOpen ? 'open' : ''}">
                        <div class="px-6 py-4">${content}</div>
                    </div>
                </div>
            `;
        }

        function toggleSection(id) {
            const content = document.getElementById(id);
            const icon = document.getElementById(id + '-icon');
            content.classList.toggle('open');
            icon.textContent = content.classList.contains('open') ? '‚ñº' : '‚ñ∂';
        }

        function formatValue(value, suffix = '') {
            if (value === null || value === undefined || value === '' || value === 'NOT_REPORTED' || value === 'UNCERTAIN') {
                return '<span class="text-red-600 font-semibold">NOT REPORTED</span>';
            }
            if (value === 'N/A' || value === 'NA') {
                return '<span class="text-gray-400">N/A</span>';
            }
            return value + suffix;
        }

        function formatStudyIdentification(data) {
            const si = data.study_identification || {};
            return `
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm font-semibold text-gray-600">Title</p>
                        <p class="text-gray-900">${si.title || 'Not reported'}</p>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-gray-600">Trial Registration</p>
                        <p class="text-gray-900">${si.trial_registration || 'Not reported'}</p>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-gray-600">Authors</p>
                        <p class="text-gray-900 text-sm">${Array.isArray(si.authors) ? si.authors.join(', ') : (si.authors || 'Not reported')}</p>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-gray-600">Journal</p>
                        <p class="text-gray-900">${si.journal || 'Not reported'}</p>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-gray-600">Year</p>
                        <p class="text-gray-900">${si.year || 'Not reported'}</p>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-gray-600">DOI</p>
                        <p class="text-gray-900 text-sm">${si.doi || 'Not reported'}</p>
                    </div>
                </div>
            `;
        }

        function formatStudyDesign(data) {
            const sd = data.study_design || {};
            let html = `
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm font-semibold text-gray-600">Study Type</p>
                        <p class="text-gray-900">${formatValue(sd.type)}</p>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-gray-600">Blinding</p>
                        <p class="text-gray-900">${formatValue(sd.blinding)}</p>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-gray-600">Randomization Method</p>
                        <p class="text-gray-900">${formatValue(sd.randomization_method || sd.randomization)}</p>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-gray-600">Duration</p>
                        <p class="text-gray-900">${formatValue(sd.duration || sd.duration_total)}</p>
                    </div>
                </div>
            `;
            return html;
        }

        function formatPopulation(data) {
            const pop = data.population || {};
            return `
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="bg-blue-50 p-3 rounded">
                        <p class="text-sm font-semibold text-gray-600">Screened</p>
                        <p class="text-2xl font-bold text-blue-600">${pop.total_screened || 'N/A'}</p>
                    </div>
                    <div class="bg-green-50 p-3 rounded">
                        <p class="text-sm font-semibold text-gray-600">Randomized</p>
                        <p class="text-2xl font-bold text-green-600">${pop.total_randomized || 'N/A'}</p>
                    </div>
                    <div class="bg-purple-50 p-3 rounded">
                        <p class="text-sm font-semibold text-gray-600">Analyzed (ITT)</p>
                        <p class="text-2xl font-bold text-purple-600">${pop.total_analyzed_itt || 'N/A'}</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <p class="text-sm font-semibold text-gray-600">Age (Mean ¬± SD)</p>
                        <p class="text-gray-900">${pop.age_mean || 'N/A'}${pop.age_sd ? ' ¬± ' + pop.age_sd : ''}</p>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-gray-600">Male %</p>
                        <p class="text-gray-900">${pop.sex_male_percent || 'N/A'}${pop.sex_male_percent ? '%' : ''}</p>
                    </div>
                </div>
            `;
        }

        function formatInterventions(data) {
            const interventions = data.interventions || [];
            if (interventions.length === 0) return '<p class="text-gray-500">No intervention data extracted</p>';
            
            let html = '<div class="overflow-x-auto mb-4">';
            html += '<table class="w-full text-sm border border-gray-300">';
            html += '<thead class="bg-gray-100"><tr>';
            html += '<th class="border border-gray-300 p-2 text-left">Arm</th>';
            html += '<th class="border border-gray-300 p-2 text-left">Dose</th>';
            html += '<th class="border border-gray-300 p-2 text-center bg-blue-50">Randomized</th>';
            html += '<th class="border border-gray-300 p-2 text-center bg-green-50">Analyzed</th>';
            html += '<th class="border border-gray-300 p-2 text-center">Duration</th>';
            html += '</tr></thead><tbody>';
            
            interventions.forEach((intervention, idx) => {
                html += '<tr class="hover:bg-gray-50">';
                html += `<td class="border border-gray-300 p-2 font-semibold">${intervention.arm_name || 'Arm ' + (idx + 1)}</td>`;
                html += `<td class="border border-gray-300 p-2">${formatValue(intervention.dose)}</td>`;
                html += `<td class="border border-gray-300 p-2 text-center bg-blue-50 font-semibold">${formatValue(intervention.n_randomized)}</td>`;
                html += `<td class="border border-gray-300 p-2 text-center bg-green-50 font-semibold">${formatValue(intervention.n_analyzed)}</td>`;
                html += `<td class="border border-gray-300 p-2 text-center">${formatValue(intervention.duration)}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            return html;
        }

        function formatPrimaryOutcomes(data) {
            const outcomes = data.outcomes?.primary || [];
            if (outcomes.length === 0) return '<p class="text-gray-500">No primary outcomes extracted</p>';
            
            let html = '';
            outcomes.forEach((outcome, idx) => {
                html += `<div class="mb-6 ${idx > 0 ? 'pt-6 border-t border-gray-200' : ''}">`;
                html += `<h4 class="font-semibold text-lg text-gray-900 mb-3">${outcome.outcome_name || 'Outcome ' + (idx + 1)}</h4>`;
                
                if (outcome.results_by_arm && outcome.results_by_arm.length > 0) {
                    html += '<div class="overflow-x-auto">';
                    html += '<table class="w-full text-xs border border-gray-300">';
                    html += '<thead class="bg-gray-100"><tr>';
                    html += '<th class="border p-2">Arm</th>';
                    html += '<th class="border p-2">N</th>';
                    html += '<th class="border p-2 bg-blue-50">Mean</th>';
                    html += '<th class="border p-2 bg-blue-50">SD</th>';
                    html += '<th class="border p-2 bg-green-50">Events</th>';
                    html += '<th class="border p-2 bg-green-50">Total</th>';
                    html += '</tr></thead><tbody>';
                    
                    outcome.results_by_arm.forEach(result => {
                        html += '<tr>';
                        html += `<td class="border p-2 font-medium">${result.arm || 'N/A'}</td>`;
                        html += `<td class="border p-2">${formatValue(result.n)}</td>`;
                        html += `<td class="border p-2 bg-blue-50">${formatValue(result.mean)}</td>`;
                        html += `<td class="border p-2 bg-blue-50">${formatValue(result.sd)}</td>`;
                        html += `<td class="border p-2 bg-green-50">${formatValue(result.events)}</td>`;
                        html += `<td class="border p-2 bg-green-50">${formatValue(result.total)}</td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table></div>';
                }
                
                if (outcome.effect_estimate || outcome.between_group_comparison) {
                    const effect = outcome.effect_estimate || outcome.between_group_comparison;
                    html += '<div class="mt-3 p-3 bg-blue-50 rounded">';
                    html += '<p class="font-semibold mb-2">Effect Estimate</p>';
                    html += '<p class="text-sm">Measure: ' + formatValue(effect.effect_measure || effect.type) + '</p>';
                    html += '<p class="text-sm">Estimate: ' + formatValue(effect.effect_estimate || effect.value) + '</p>';
                    html += '<p class="text-sm">95% CI: [' + formatValue(effect.ci_95_lower || effect.ci_lower) + ', ' + formatValue(effect.ci_95_upper || effect.ci_upper) + ']</p>';
                    html += '<p class="text-sm">P-value: ' + formatValue(effect.p_value) + '</p>';
                    html += '</div>';
                }
                
                html += '</div>';
            });
            
            return html;
        }

        function formatSecondaryOutcomes(data) {
            const outcomes = data.outcomes?.secondary || [];
            if (outcomes.length === 0) return '<p class="text-gray-500">No secondary outcomes extracted</p>';
            return formatPrimaryOutcomes({outcomes: {primary: outcomes}});
        }

        function formatSubgroups(data) {
            const subgroups = data.subgroup_analyses || [];
            if (subgroups.length === 0) return '<p class="text-gray-500">No subgroup analyses</p>';
            
            let html = '';
            subgroups.forEach((sg, idx) => {
                html += `<div class="mb-4 ${idx > 0 ? 'pt-4 border-t border-gray-200' : ''}">`;
                html += `<h4 class="font-semibold text-gray-900 mb-2">${sg.subgroup_variable || 'Subgroup ' + (idx + 1)}</h4>`;
                
                if (sg.p_interaction) {
                    html += `<p class="text-sm text-gray-600 mb-2">P for interaction: ${sg.p_interaction}</p>`;
                }
                
                html += '</div>';
            });
            
            return html;
        }

        function formatAdverseEvents(data) {
            const aes = data.adverse_events || [];
            if (aes.length === 0) return '<p class="text-gray-500">No adverse events reported</p>';
            
            let html = '<div class="overflow-x-auto"><table class="w-full text-sm border">';
            html += '<thead class="bg-gray-50"><tr>';
            html += '<th class="border p-2 text-left">Event</th>';
            html += '<th class="border p-2 text-center">Severity</th>';
            html += '</tr></thead><tbody>';
            
            aes.forEach(ae => {
                html += '<tr>';
                html += `<td class="border p-2">${ae.event_name || 'Unnamed'}</td>`;
                html += `<td class="border p-2 text-center">${ae.severity || 'N/A'}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            return html;
        }

        function formatMetadata(data) {
            const meta = data.extraction_metadata || data.metadata || {};
            const conf = data.confidence_scores || meta.confidence_scores || {};
            
            // Build detailed extraction info
            let extractionMethods = 'N/A';
            if (meta.extraction_methods && Array.isArray(meta.extraction_methods)) {
                extractionMethods = meta.extraction_methods.join(', ');
            }
            
            let html = '<div class="space-y-4">';
            
            // Extraction methods used
            html += '<div class="bg-blue-50 border border-blue-200 rounded-lg p-4">';
            html += '<h4 class="font-semibold text-gray-900 mb-3">üìä Extraction Methods Used</h4>';
            html += '<div class="grid grid-cols-2 gap-3 text-sm">';
            html += `<div><span class="font-medium">Methods:</span> ${extractionMethods}</div>`;
            html += `<div><span class="font-medium">LLM Model:</span> ${meta.llm_model || 'N/A'}</div>`;
            html += `<div><span class="font-medium">Tables Found:</span> ${meta.tables_found || 0}</div>`;
            html += `<div><span class="font-medium">PDF Pages:</span> ${meta.pdf_pages || 0}</div>`;
            html += `<div><span class="font-medium">LLM Tokens:</span> ${meta.llm_tokens || 'N/A'}</div>`;
            html += `<div><span class="font-medium">Completion:</span> ${meta.llm_finish_reason || 'N/A'}</div>`;
            html += '</div></div>';
            
            // Basic info
            html += '<div class="grid grid-cols-2 gap-4 mt-4">';
            html += '<div>';
            html += '<p class="text-sm font-semibold text-gray-600">Extraction Date</p>';
            html += `<p class="text-gray-900">${data.extraction_date ? new Date(data.extraction_date).toLocaleString() : 'N/A'}</p>`;
            html += '</div>';
            html += '<div>';
            html += '<p class="text-sm font-semibold text-gray-600">PDF Stored</p>';
            html += `<p class="text-gray-900">${data.has_pdf ? '‚úì Yes (re-extraction available)' : '‚úó No'}</p>`;
            html += '</div>';
            html += '</div>';
            
            html += '</div>';
            return html;
        }

        async function loadStudiesLibrary() {
            try {
                const response = await fetch('/api/studies');
                const data = await response.json();
                allStudies = data.studies;
                displayStudiesLibrary(allStudies);
            } catch (error) {
                document.getElementById('studiesLibrary').innerHTML = 
                    '<p class="text-red-600">Error loading studies</p>';
            }
        }

        function displayStudiesLibrary(studies) {
            const container = document.getElementById('studiesLibrary');
            
            if (studies.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No studies found. Upload a PDF to get started.</p>';
                return;
            }
            
            container.innerHTML = studies.map(study => `
                <div class="border rounded-lg p-4 hover:bg-gray-50">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-900">${study.study_identification.title || 'Untitled'}</h3>
                            <p class="text-sm text-gray-600">
                                ${study.study_identification.year || 'N/A'} | 
                                ${study.study_identification.journal || 'Unknown journal'} | 
                                ${study.interventions.length} arms
                            </p>
                            <p class="text-xs text-gray-500 mt-1">
                                Extracted: ${study.extraction_date ? new Date(study.extraction_date).toLocaleDateString() : 'N/A'}
                            </p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="viewStudy(${study.id})" 
                                    class="px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                View
                            </button>
                            <button onclick="reExtractStudy(${study.id})" 
                                    class="px-3 py-1 text-sm bg-orange-100 text-orange-700 rounded hover:bg-orange-200">
                                Re-extract
                            </button>
                            <button onclick="downloadStudyExcel(${study.id})" 
                                    class="px-3 py-1 text-sm bg-green-100 text-green-700 rounded hover:bg-green-200">
                                Excel
                            </button>
                            <button onclick="deleteStudy(${study.id})" 
                                    class="px-3 py-1 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function loadCompareView() {
            if (allStudies.length === 0) {
                loadStudiesLibrary().then(() => populateCompareSelection());
            } else {
                populateCompareSelection();
            }
        }

        function populateCompareSelection() {
            const container = document.getElementById('compareSelection');
            container.innerHTML = allStudies.map(study => `
                <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded">
                    <input type="checkbox" value="${study.id}" onchange="toggleCompareSelection(${study.id})"
                           ${selectedForComparison.includes(study.id) ? 'checked' : ''}>
                    <span class="text-sm">${study.study_identification.title || 'Untitled'} (${study.study_identification.year})</span>
                </label>
            `).join('');
        }

        function toggleCompareSelection(studyId) {
            if (selectedForComparison.includes(studyId)) {
                selectedForComparison = selectedForComparison.filter(id => id !== studyId);
            } else {
                selectedForComparison.push(studyId);
            }
        }

        async function performComparison() {
            if (selectedForComparison.length < 2) {
                alert('Please select at least 2 studies to compare');
                return;
            }
            
            try {
                const response = await fetch('/api/studies/compare', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({study_ids: selectedForComparison})
                });
                const data = await response.json();
                displayComparison(data);
            } catch (error) {
                alert('Comparison failed: ' + error.message);
            }
        }

        function displayComparison(data) {
            const container = document.getElementById('comparisonResults');
            
            container.innerHTML = `
                <h3 class="font-semibold text-lg mb-4">Comparison Results</h3>
                <div class="overflow-x-auto">
                    <table class="w-full border">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="border p-2 text-left">Study</th>
                                <th class="border p-2 text-left">Year</th>
                                <th class="border p-2 text-left">Interventions</th>
                                <th class="border p-2 text-left">Sample Size</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.studies.map(study => `
                                <tr>
                                    <td class="border p-2 text-sm">${(study.study_identification.title || 'Untitled').substring(0, 50)}...</td>
                                    <td class="border p-2">${study.study_identification.year || 'N/A'}</td>
                                    <td class="border p-2 text-sm">${study.interventions.map(i => i.arm_name).join(', ')}</td>
                                    <td class="border p-2">${study.population?.total_randomized || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function viewStudy(studyId) {
            try {
                const response = await fetch(`/api/studies/${studyId}`);
                const study = await response.json();
                extractedData = study;
                showTab('extract');
                displayResults(study);
                // Show new study actions when viewing an existing study
                document.getElementById('newStudyActions').classList.remove('hidden');
            } catch (error) {
                alert('Error loading study');
            }
        }

        async function reExtractStudy(studyId) {
            if (!confirm('Re-extract this study?\n\nThis will overwrite existing data and take 30-60 seconds.\n\nContinue?')) {
                return;
            }
            
            alert('Re-extraction started. Please wait 30-60 seconds...');
            
            try {
                const response = await fetch(`/api/studies/${studyId}/re-extract`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Study re-extracted successfully!');
                    loadStudiesLibrary();
                } else {
                    alert('Re-extraction failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Re-extraction error: ' + error.message);
            }
        }

        async function deleteStudy(studyId) {
            const study = allStudies.find(s => s.id === studyId);
            const studyTitle = study ? (study.study_identification.title || 'this study') : 'this study';
            
            if (!confirm(`DELETE STUDY?\n\n"${studyTitle}"\n\nThis will permanently delete all data.\n\nThis CANNOT be undone!\n\nContinue?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/studies/${studyId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    allStudies = allStudies.filter(s => s.id !== studyId);
                    displayStudiesLibrary(allStudies);
                    alert('Study deleted successfully!');
                } else {
                    alert('Delete failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Delete error: ' + error.message);
            }
        }

        function downloadStudyExcel(studyId) {
            window.location.href = `/api/export/csv/${studyId}`;
        }

        function exportAllStudies() {
            window.location.href = '/api/export/all-studies';
        }

        function downloadJSON() {
            if (!extractedData) return;
            const blob = new Blob([JSON.stringify(extractedData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'trial_data.json';
            a.click();
        }

        function downloadExcel() {
            if (extractedData && extractedData.id) {
                window.location.href = `/api/export/csv/${extractedData.id}`;
            }
        }

        function extractNewStudy() {
            // Hide the new study actions
            document.getElementById('newStudyActions').classList.add('hidden');
            
            // Clear the results
            document.getElementById('resultsContainer').classList.add('hidden');
            document.getElementById('resultsContainer').innerHTML = '';
            
            // Clear the file input
            fileInput.value = '';
            document.getElementById('fileName').textContent = 'Click to upload PDF';
            
            // Clear any errors
            document.getElementById('errorDiv').classList.add('hidden');
            
            // Add visual feedback - briefly highlight the upload area
            const uploadArea = document.querySelector('.border-2.border-dashed');
            uploadArea.classList.add('border-green-500', 'bg-green-50');
            setTimeout(() => {
                uploadArea.classList.remove('border-green-500', 'bg-green-50');
                uploadArea.classList.add('border-gray-300');
            }, 1000);
            
            // Scroll to top of extract section
            document.querySelector('.bg-white.rounded-lg.shadow-lg.p-6.mb-6').scrollIntoView({ behavior: 'smooth' });
            
            // Update extraction count if it exists
            updateExtractionCount();
        }
        
        function goToLibrary() {
            showTab('library');
        }
        
        function updateExtractionCount() {
            // Get today's extractions from studies
            fetch('/api/studies')
                .then(response => response.json())
                .then(data => {
                    const today = new Date().toDateString();
                    const todaysStudies = data.studies.filter(study => {
                        if (!study.extraction_date) return false;
                        return new Date(study.extraction_date).toDateString() === today;
                    });
                    
                    // Update or create count display
                    let countDisplay = document.getElementById('extractionCount');
                    if (!countDisplay) {
                        const headerDiv = document.querySelector('.bg-white.rounded-lg.shadow-lg.p-6.mb-6');
                        countDisplay = document.createElement('div');
                        countDisplay.id = 'extractionCount';
                        countDisplay.className = 'mt-2 text-sm text-gray-600';
                        headerDiv.querySelector('p').after(countDisplay);
                    }
                    countDisplay.innerHTML = `üìä Studies extracted today: <span class="font-bold text-blue-600">${todaysStudies.length}</span> | Total studies: <span class="font-bold">${data.studies.length}</span>`;
                })
                .catch(error => console.error('Error updating count:', error));
        }
        
        // Update count on page load
        document.addEventListener('DOMContentLoaded', () => {
            updateExtractionCount();
        });

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorDiv').classList.remove('hidden');
        }
    </script>
</body>
</html>